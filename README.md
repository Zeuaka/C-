# ЛАБОРАТОРНАЯ РАБОТА №5 
## LINQ-ЗАПРОСЫ

**Вариант 1** 
В файле LR5-var1.xls приведён фрагмент базы данных «Детские товары» о поставках товаров в 
магазины районов города. База данных состоит из четырёх таблиц. Таблица «Движение товаров» 
содержит записи о поставках товаров в магазины в августе 2024 г., а также информацию о проданных 
товарах. Поле Тип операции содержит значение «Поступление», «Продажа» или «Возврат», а в 
соответствующее поле «Количество упаковок» занесена информация о том, сколько упаковок товара 
поступило в магазин или было продано в течение дня; поле «Наличие карты клиента» содержит 
значение Да или Нет. Таблица «Товар» содержит информацию об основных характеристиках каждого 
товара. Таблица «Магазин» содержит информацию о местонахождении магазинов. Таблица 
«Категория» содержит данные о категориях товаров и соответствующие возрастные ограничения. На 
рисунке приведена схема указанной базы данных.


<img width="345" height="215" alt="image" src="https://github.com/user-attachments/assets/b5a4b032-8c95-4f62-8ab7-0156808a548f" />


Программа состоит из 3-х файлов: 

ProductActs.cs для описания классов обьектов, с которыми проводится работа, а также перегрузки

их вывода в консоль,

LINQ.cs для формирования структуры LINQ запросов, а так же работы с exel,

А так же Program.cs, который содержит основной метод main и методы для добавления элементов в таблицы 

---

### ***Файл: LINQ.cs***

Основные компоненты класса:

### Приватные поля:

_movements, _products, _stores, _categories — коллекции для хранения данных.

_filePath — путь к Excel-файлу.

_nextMovementId, _nextProductArticle, _nextStoreId, _nextCategoryId — счетчики для генерации уникальных идентификаторов.

Конструктор:

Инициализирует коллекции и устанавливает контекст лицензии EPPlus.

Вызывает метод CreateTestData() для заполнения тестовыми данными.

---

### ReadFromExcel()

Назначение: Загружает данные из Excel-файла в соответствующие коллекции.

### Алгоритм:

Проверяет существование файла.

Очищает текущие коллекции.

Читает данные из листов: "Категория", "Магазин", "Товар", "Движение товаров".

***Алгоритм работы:***

Циклом проходит по всем строкам листа, разбивает данные из ячеек, попутно проверяя их заполненность.

Далее добавляет запись в подходящий список данных из полей класса.



Обновляет счетчики идентификаторов.

***Алгоритм работы:***

За каждый элемент в списках полей класса, увеличивает константные значения полей класса на 1

---


### CreateTestData()

Создает тестовые данные

### ViewData(string tableName)

Метод отображает в консоли данные выбранной таблицы

***Алгоритм работы:***

В зависимости от переданного tableName, срабатывает один з 5 кейсов:

---

## Обработка случая "movements" (Движение товаров)

Если движений нет - выводится сообщение и инициализируется выход из метода

Для КАЖДОГО движения товара выполняются следующие действия:

С помощью цикла foreach (var movement in _movements) 

Находится товар по артикулу из движения

Находится магазин по ID из движения

так как по этим полям данные таблицы связаны.

Далее выводится информация о движении + название товара + район магазина

---

Дальнейший механизм работы для других кейсов подразумевает такой же принцип работы, с небольшими правками.

---

## Обработка случая "products" (Товары)

Для каждого товара находится его категория по CategoryId

Выводится товар + название категории

## Обработка случая "stores" (Магазины) и "categories" (Категории)

Просто выводится каждый магазин или категория

все форматы вывода уже описаны в классе ProductActs, поэтому вывод останется информативным.

---


### DeleteItem(string tableName, int id)

Метод для удаления записи из таблицы

Работа метода так же зависит от переданного tableName и подразумевает работу с кейсами:

## Обработка случая "movements"

***Алгоритм работы:***

Совершается проход по всем записанным движениям, в поисках того, чей id совпадет с переданным методу.

После чего происходит простое удаление записи из коллекции с movements

## Обработка случая "products"

***Алгоритм работы:***

Здесь все сложнее, так как от таблицы products так же зависят записи в movements.

Алгоритм поиска товара остается таким же, как и поиск движения товара, однако добавляется еще

проход по всем движениям, в которых фигурировал id товара. Найденные движения формируются в отдельный список,

после чего последовательно удаляются из коллекции movements

## Обработка случая "stores"

***Алгоритм работы:***

Имеет такой же алгоритм работы, как и в случае с products, однако поиск движений

происходит уже по id магазина.

## Обработка случая "categories"

***Алгоритм работы:***

Самый сложный случай, сначала по обычному сценарию удаляется категория товара,

после чего, уже с помощью вложенного цикла foreach происходит удаление всех товаров,

подходящих по данную категорию. Далее вкладывается еще один цикл foreach, еще ниже уровнем,

в котором последовательно удаляются движения, в которых фигурировали данные товары.

---

### Методы добавления записей:

## Добавление движения товара:

Запрашивает у пользователя данные о айди товара и магазина, после чего проверяет существование таковых.

После чего добавляет запись в коллекцию с движениями

## Добавление товара:

Запрашивает у пользователя данные о айди категории, после чего проверяет ее существование.

После чего добавляет запись в коллекцию с товарами

## Добавление категории или магазина:

Записи в этих таблицах являются независимыми и не требуют никаких проверок.

---

### LINQ Запросы

Запросы выполняются с помощью API IEnurable, который позволяет интегрировать 

## GetSalesWithCustomerCards() (запрос с обращением к одной таблице)

Запрос обращается к таблице с движениями и выводит все, где тип операции продажа, а в поле с картой покупателя выставлено "да"

## GetTotalSales() (запрос с обращением к двум таблицам)

Запрос выбирает количество проданного товара из таблицы с движениями и стоимость товара из таблицы с товарами.

после чего перемножает количества на цены и суммирует их

## GetAveragePriceByAgeGroup()

Объединяем товары с категориями (чтобы знать возрастную группу товара)

Объединяем товары с движениями (чтобы учитывать только поступившие товары)

Результат: "Виртуальная таблица" со всеми полями из товаров, категорий и движений

Оставляем только записи, где тип операции = "Поступление"

Группируем все товары по полю AgeRestriction из категорий

Например: все товары с возрастной группой "17+" попадают в одну группу

Для каждой группы вычисляем среднюю цену товаров

Этот запрос показывает, сколько в среднем стоят товары в каждой возрастной категории, учитывая только те товары, которые были поставлены в магазины.

## GetTotalSalesInWalkerDistrict()

Обьединям Движения + Магазины - чтобы узнать в каком районе была продажа

Обьединям Движения + Товары - чтобы узнать цену проданного товара

Оставляем только записи, где тип операции только "Продажи", 

а район только Дзержинский

Выбираем из получившейся таблицы только количество проданных упаковок и цену упаковки 

Далее вычисляем общую сумму продаж

---

### SaveToExcel()

Создается пустой Excel-файл в памяти

По умолчанию содержит один пустой лист

Берется первый лист (индекс 0) и переименовывается в "Категория"

Первая строка заполняется названиями столбцов.

Далее осуществляется проход по всем категориям с помощью цикла, который заканчивается, когда счетчкик достигает конца коллекции с категориями.

Строки заполняются данными

Для остальных листов алгоритм остается одинаковым

---


---

---

Ниже представлены примеры работы программы в каждом из разделов заданий.


### Задание 1

<img width="411" height="94" alt="image" src="https://github.com/user-attachments/assets/74aa42e9-788a-4d26-bfc4-b2bf5297d2d1" />



### Задание 2

<img width="425" height="89" alt="image" src="https://github.com/user-attachments/assets/b5956f5a-1045-4100-9127-31b926d6df88" />



### Задание 3

<img width="448" height="279" alt="image" src="https://github.com/user-attachments/assets/d94977e5-cb20-46b0-82f8-475776fbd8bc" />



### Задание 4

<img width="442" height="245" alt="image" src="https://github.com/user-attachments/assets/e366a859-aa04-4058-b42d-eb900a904ec5" />


### Содержимое TXT файла :

<img width="520" height="97" alt="image" src="https://github.com/user-attachments/assets/85ea870a-64fd-49eb-9c26-509634929c6f" />


### Задание 5

<img width="397" height="222" alt="image" src="https://github.com/user-attachments/assets/c4306939-c09e-4567-bf9b-6a8daf15cd33" />


### Содержимое TXT файла students :

<img width="393" height="190" alt="image" src="https://github.com/user-attachments/assets/7b203ec2-efd4-45eb-9a81-58a75554e7fb" />


### Содержимое TXT файла logins :

<img width="387" height="171" alt="image" src="https://github.com/user-attachments/assets/e669e792-6691-4ef6-96f8-d86608953cd1" />


### Задания 6-7

<img width="536" height="247" alt="image" src="https://github.com/user-attachments/assets/785fcf4f-32e7-44ec-8002-98dd9b7e2355" />


<img width="544" height="237" alt="image" src="https://github.com/user-attachments/assets/81574576-c911-46e3-9e30-bdc7f19d2abc" />


<img width="420" height="258" alt="image" src="https://github.com/user-attachments/assets/20a8cd45-6889-4c22-8b31-96e766faafa2" />


<img width="393" height="310" alt="image" src="https://github.com/user-attachments/assets/6ab29f8c-af2c-4274-a6ba-d1ed842490fd" />




